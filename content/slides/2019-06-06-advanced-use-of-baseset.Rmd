---
title: "Advanced use of BaseSet"
author: 'Llu√≠s Revilla Sancho'
subtitle: "Exploring Bioconductor packages"
date: "`r Sys.Date()`"
slug: BaseSet-advanced
twitter: "@Lluis_Rev"
tags: [r]
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE)
library("tidyverse")
library("BaseSet")
```

## Bioconductor packages

We can quickly access the dependencies and maintainers of Bioconductor' packages:

```{r download}
views <- "https://bioconductor.org/packages/devel/bioc/VIEWS"
dcf <- read.dcf(url(views), c("Package", "Maintainer", "dependencyCount", 
                  "Depends", "Imports"))
tbl <- as_tibble(dcf) %>%
   mutate(
     Maintainer = gsub("[[:space:]]+", " ", Maintainer),
     dependencyCount = as.integer(dependencyCount),
     Core = grepl("Bioconductor Package Maintainer", Maintainer),
     Maintainer = stringr::str_split(Maintainer, ",\\s*|( and )"),
     Depend = stringr::str_split(Depends, ",\\s+"), 
     Import = stringr::str_split(Imports, ",\\s+"),
     )
```

This is a modified code from Martin Morgan

---

The content:

```{r tbl, echo=FALSE, message=TRUE, warning=FALSE}
head(tbl)
```

As you can see the Maintainers field is a list and also the Depends and Import.

---

## Maintainers

Now we have several sets each package with the dependencies and each package and the maintainers. We must tidy them:
```{r maintainers}
prepare <- unnest(tbl[, c("Maintainer", "Package")])
colnames(prepare) <- c("sets", "elements")
maintainers <- tidySet(prepare)
is_nested(maintainers)
```

We can see with `nElements(maintainers)` that it has less than `r nElements(maintainers)` maintainers. Because some appear duplicated:

```{r carey}
grep("Carey", name_elements(maintainers), value = TRUE)
```

---

Now we are ready for some plots:

```{r maintainers1, message=FALSE, warning=FALSE, fig.height=4, dev='svg'}
maintainers %>% 
  set_size() %>% 
  arrange(-size) %>% 
  select(-probability) %>%
  ggplot() +
  geom_histogram(aes(size)) + 
  scale_y_log10() +
  theme_minimal() +
  labs(title = "Maintainers by package")
```

---


```{r maintainers2, message=FALSE, warning=FALSE, fig.height=4, dev='svg'}
maintainers %>% 
  filter_element(!grepl("Bioconductor Package Maintainer", 
                        as.character(elements))) %>% 
  element_size() %>% 
  arrange(-size) %>% 
  select(-probability) %>%
  ggplot() +
  geom_histogram(aes(size)) + 
  scale_y_log10() +
  theme_minimal() +
  labs(title = "Packages maintained by person")
```

---

We can have a look at the packages maintained by Bioconductor:

```{r Bioc_packages}
Bioconductor_packages <- maintainers %>% 
  filter_element(grepl("Bioconductor", 
                       elements)) %>% 
  droplevels() %>% 
  pull_set(sets)
Bioconductor_packages
```

```{r rcore, include=FALSE}
rcore <- c("base", "compiler", "datasets", "grDevices", "graphics", "grid", 
           "methods", "parallel", "splines", "stats", "stats4", "tcltk", "tools", 
           "utils", "KernSmooth", "Mass", "Matrix", "boot", "class", "cluster", 
           "codetools", "foreign", "lattice", "mgcv", "nlme", "nnet", "rpart", 
           "spatial", "survival")
```

And we can see which are installed by default or recommended at the [FAQs](https://cran.r-project.org/doc/FAQ/R-FAQ.html#Which-add_002don-packages-exist-for-R_003f):
in total `r length(rcore)`.

---

## Dependencies

Now let's work on the dependencies.
First some clean up of the package names:

```{r dependencies}
l <- apply(tbl[, c("Depend", "Import")], 1, function(x){
  y <- unlist(x, use.names = FALSE)
  y <- gsub(" ?\\(.*", "", y)
  y <- y[!grepl("\\)", y)]
  y <- y[y != ""]
  unique(y[!is.na(y)])
})
names(l) <- tbl[, "Package", drop = TRUE]
```

---

Now we are ready to transform to a TidySet:

```{r dependencies0, message=FALSE, warning=FALSE}
packages <- tidySet(l) %>% 
  filter_element(elements != "R") %>% 
  mutate_element(Origin = case_when(
    elements  %in%  rcore ~ "R core",
    elements  %in% Bioconductor_packages ~ "Bioconductor Core",
    elements  %in% name_sets(maintainers) ~  "Bioconductor",
    TRUE ~ "Other")) %>% 
    activate("sets") %>% 
    mutate(Type = case_when(
    sets  %in% rcore ~ "R core",
    sets  %in% Bioconductor_packages ~ "Bioconductor Core",
    sets  %in% name_sets(maintainers) ~  "Bioconductor",
    TRUE ~ "Other"))

sets(packages) <- inner_join(sets(packages),
                             tbl[, c("Package", "dependencyCount")], 
                             by = c("sets" = "Package"))
is_nested(packages)
```

In this case we can see that some packages appear as dependencies of others..

---

We can plot some

```{r dependensies1, message=FALSE, warning=FALSE, fig.height=4, dev='svg'}
packages %>% 
  set_size() %>% 
  arrange(-size) %>% 
  select(-probability) %>%
  ggplot() +
  geom_histogram(aes(size), bins = 50) +
  scale_y_log10() +
  theme_minimal() +
  labs(title = "Packages dependencies")
```

---

```{r dependensies2, message=FALSE, warning=FALSE, fig.height=4, dev='svg'}
p <- packages %>% 
  element_size() %>% 
  arrange(-size) %>% 
  select(-probability) %>% 
  left_join(elements(packages), by = c("element" = "elements"))
p %>% 
  ggplot() +
  geom_histogram(aes(size)) + 
  scale_y_log10() +
  theme_minimal() +
  labs(title = "Packages depended")
```


```{r dependensies4, message=FALSE, warning=FALSE, fig.height=4, dev='svg'}
p %>% 
  ggplot(aes(Origin, size)) +
  geom_violin() +
  geom_point(position = position_jitter()) +
  theme_minimal() +
  scale_y_log10()
table(p$Origin)
```
 
---

Thanks! 
