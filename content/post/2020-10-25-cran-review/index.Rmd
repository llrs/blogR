---
title: CRAN review
author: Llu√≠s Revilla Sancho
date: '2020-10-25'
categories:
  - r
  - CRAN
tags:
  - CRAN
  - R
  - reviews
slug: CRAN-review
editor_options:
  chunk_output_type: console
featured: no
draft: yes
image:
  caption: ''
  focal_point: ''
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE)
```

[cransays](https://github.com/lockedata/cransays) is a package to check package submissions which on the online documentation provides a [dashboard which](https://lockedata.github.io/cransays/articles/dashboard.html) is updated each hour.
At the same time recently (since 2020/09/12) the status of the queues and folders of submissions are stored. 
Using this information and the recent [script provided by Tim Taylor](https://github.com/tjtnew/newbies) I'll check how are the submissions on CRAN. 

```{r prepare, eval = FALSE}
path_zip <- here::here("static", "cransays-history.zip") # From downloading the cransays repository branch history
dat <- unzip(path_zip, exdir = "static")
csv <- dat[grepl("*.csv$", x = dat)]
dates <- gsub("cran-incoming-(.+)\\.csv", "\\1", basename(csv))
date <- as.POSIXct(dates, format = "%Y%m%dT%H%M")
f <- sapply(csv, read.csv)
m <- function(x, y) {
  merge(x, y, sort = FALSE, all = TRUE)
}
updates <- Reduce(m, f)
write.csv(updates, file = "static/cran_till_20201025.csv",  row.names = FALSE)
```

```{r load}
cran_submissions <- read.csv(here::here("static", "cran_till_20201025.csv"))
col_names <- c("package", "version", "snapshot_time", "folder", "subfolder")
cran_submissions <- cran_submissions[, col_names]
library("tidyverse")
library("lubridate")
cran_submissions$snapshot_time <- as.POSIXct(cran_submissions$snapshot_time)
```


## CRAN load

We all know that CRAN is busy with updates, fixes and so on.
Now we can see how busy is usually CRAN. 
How much do the 4 reviewers of CRAN have on their plates?

```{r cran-times}
cran_submissions <- cran_submissions[!is.na(cran_submissions$version), ]
theme_set(theme_minimal())
cran_times <- cran_submissions %>% 
  mutate(seconds = seconds(snapshot_time),
         month = month(snapshot_time),
         mday = mday(snapshot_time),
         wday = wday(snapshot_time, locale = "en_GB.UTF-8"),
         week = week(snapshot_time),
         date = as_date(snapshot_time),
         submission = paste0(package, version, collapse = "-"))
```



```{r cran-queues}
cran_times %>% 
  group_by(folder, snapshot_time) %>% 
  summarize(packages = n_distinct(package)) %>% 
  group_by(snapshot_time) %>% 
  summarize(n = sum(packages)) %>% 
  ggplot() +
  geom_path(aes(snapshot_time, n)) +
  labs(x = "Date", y = "Packages on the queue", 
       title = "Work on CRAN submissions")
```

We can see here the sampling pattern and how many packages there were. 
But in which folders are they?

```{r cran-submissions}
cran_times %>% 
  group_by(folder, snapshot_time) %>% 
  summarize(packages = n_distinct(package),
            week = unique(week)) %>% 
  ggplot() +
  geom_point(aes(snapshot_time, packages, col = fct_reorder(folder, -packages, sum))) +
  labs(x = "Date", y = "Packages",
       title = "Work on submissions", col = "Folder/Stage")
```

The trend is mostly driven by newbies folder.
We can look for patterns on the months

```{r cran-monthly}
cran_times %>% 
  arrange(folder, date, mday) %>% 
  group_by(folder, date, mday) %>% 
  summarize(packages = n_distinct(package),
            week = unique(week)) %>% 
  group_by(folder, mday) %>% 
  summarize(packages = median(packages)) %>% 
  ggplot() +
  # geom_point(aes(mday, packages, col = fct_reorder2(folder, mday, packages, sum))) +
  geom_path(aes(mday, packages, col = fct_reorder2(folder, mday, packages, sum))) +
  labs(x = "Day of the month", y = "Packages", col = "Folder/stage",
       title = "Evolution by month day")
```

Or the day of the week. (Do developers submit more on weekends?)

```{r cran-wday}
cran_times %>% 
  group_by(folder, date, wday) %>% 
  summarize(packages = n_distinct(package),
            week = unique(week)) %>% 
  group_by(folder, wday) %>% 
  summarize(packages = median(packages)) %>% 
  ggplot() +
  # geom_point(aes(wday, packages, col = fct_reorder2(folder, wday, packages, sum))) +
  geom_path(aes(wday, packages, col = fct_reorder2(folder, wday, packages, sum))) +
    labs(x = "Day of the week", y = "Packages", col = "Folder/stage",
       title = "Evolution by week day")
```




```{r cran-wday}
cran_members <- c("LH", "UL", "GS", "JH")
cran_times %>% 
  filter(!is.na(subfolder)) %>% 
  group_by(subfolder, date, mday) %>% 
  summarize(packages = n_distinct(package),
            week = unique(week)) %>% 
  group_by(subfolder, mday) %>% 
  summarize(packages = median(packages)) %>% 
  filter(subfolder %in% cran_members) %>% 
  ggplot() +
  # geom_point(aes(mday, packages, col = fct_reorder2(subfolder, mday, packages, sum))) +
  geom_path(aes(mday, packages, col = fct_reorder2(subfolder, mday, packages, sum))) +
    labs(x = "Day of the week", y = "Packages", col = "Folder/stage",
       title = "Evolution by day of the month")
```

```{r}
cran_times %>% 
  filter(!is.na(subfolder)) %>% 
  group_by(subfolder, date, wday) %>% 
  summarize(packages = n_distinct(package),
            week = unique(week)) %>% 
  group_by(subfolder, wday) %>% 
  summarize(packages = median(packages)) %>% 
  filter(subfolder %in% cran_members) %>% 
  ggplot() +
  geom_point(aes(wday, packages, col = fct_reorder2(subfolder, wday, packages, sum))) +
  geom_path(aes(wday, packages, col = fct_reorder2(subfolder, wday, packages, sum))) +
    labs(x = "Day of the week", y = "Packages", col = "Folder/stage",
       title = "Evolution by week day")
```


```{r cran-subfolder}
cran_times %>% 
  group_by(folder, subfolder) %>% 
  count(sort = TRUE) %>% 
  ungroup() %>% 
  filter(!(folder == subfolder) | is.na(subfolder))
```


## Times

Time spend on each folder/step.

```{r}
tidy <- cran_times %>%
  group_by(submission) %>% 
  arrange(snapshot_time) %>% 
  filter(row_number() == 1 | folder != lag(folder)) %>% 
  mutate(elapsed = difftime(snapshot_time, lag(snapshot_time), units = "hours")) %>% 
  ungroup()
```


## Resubmissions

One big difference between CRAN and Bioconductor or rOpenSci is that even if your package is already included each time you want to fix something it gets reviewed by someone. 
This ensures the high quality of the packages, as well as increases the pressure on the package reviewers.
This in turn raises the bar for resubmissions. 
How long between one submission and another of the same package?

### Reproducibility

<details>
```{r reproducibility, echo = FALSE}
## Reproducibility info
options(width = 120)
sessioninfo::session_info()
```
</details>
